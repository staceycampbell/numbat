#!/bin/bash
(cd misc && make fenconv) > /dev/null 2>&1
fenmoves=/tmp/fenmoves$$
fenmove=/tmp/fenmove$$
simout=/tmp/simout$$
origpgn=/tmp/origpgn$$
ucitrunc=/tmp/ucitrunc$$
allmoveslist=/tmp/allmoveslist$$
testpgn=/tmp/testpgn$$.pgn
testresult=/tmp/testresult$$
stop=0
counter=0
while [ $stop -eq 0 ]
do
    gameno=`shuf -i 1-12998 -n 1`
    pgn-extract --quiet -s --minmoves 4 --selectonly $gameno misc/GriffySr.pgn > $origpgn 2>/dev/null
    pgn-extract --quiet --notags -s -Wfen --minmoves 4 --selectonly $gameno misc/GriffySr.pgn 2>/dev/null | grep -v '^$' > $fenmoves
    cat $origpgn
    movecount=`wc -l < $fenmoves`
    movecount=`expr $movecount - 1`
    moveno=`shuf -i 2-$movecount -n 1`
    echo 'moveno' $moveno 'gameno' $gameno
    tail -n+$moveno < $fenmoves | head -n1 > $fenmove
    cat $fenmove
    misc/fenconv < $fenmove > amt_board.vh
    make amt
    ./amt > $simout
    egrep '^move_index' $simout > $allmoveslist
    genmoves=`cat $simout | wc -l`
    allmoves="`cat $allmoveslist | awk '{ print $2 }'`"
    echo $allmoves
    pgn-extract --quiet -s -Wuci $origpgn
    pgn-extract --quiet --notags -s -Wuci $origpgn | grep -v '^$' > $ucitrunc
    playedmove=`cat $ucitrunc | cut -d ' ' -f $moveno`
    prevmoveno=`expr $moveno - 1`
    if [ $prevmoveno -lt 1 ]
    then
        echo problem $moveno $prevmoveno
        exit 1
    fi
    prevmoves=`cat $ucitrunc | cut -d ' ' -f 1-$prevmoveno`
    echo $allmoves | grep -w -q $playedmove
    status=$?
    if [ $status -ne 0 ]
    then
        echo played move $playedmove not generated
    fi
    for move in $allmoves
    do
        egrep '^\[' $origpgn > $testpgn
        echo '' >> $testpgn
        echo "$prevmoves" >> $testpgn
        echo $move >> $testpgn
        outcome=`fgrep $move $allmoveslist | awk ' { print $3 } '`
        if [ $outcome = 'B' ]
        then
            echo '1-0' >> $testpgn
        elif [ $outcome = 'W' ]
        then
            echo '0-1' >> $testpgn
        else
            echo '1/2-1/2' >> $testpgn
        fi
        pgn-extract -s --quiet $testpgn >/dev/null 2>$testresult
        fgrep 'Failed to make move' $testresult
        status=$?
        if [ $status -eq 0 ]
        then
            echo illegal move found, see $testresult
            stop=1
        fi
    done
    counter=`expr $counter + 1`
    if [ $counter -eq 10 ]
    then
        stop=1
    fi
done
rm -f $fenmoves $fenmove $simout $origpgn $ucitrunc $allmoveslist $testpgn $testresult
